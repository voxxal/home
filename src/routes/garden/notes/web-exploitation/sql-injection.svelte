<script context="module">
  export const metadata = { title: "sql injection", lastUpdated: "May 2023" };
</script>

<script lang="ts">
  import Prism from "$lib/components/Prism.svelte";
  import "prismjs/components/prism-sql";
  import initSqlJs, { type Database } from "sql.js";
  import { onMount } from "svelte";

  let db: Database;
  let boolPassword = "";
  let boolSolveState: "" | "solved" | "wrong" | "error" = "";
  onMount(() => {
    const initSql = async () => {
      const SQL = await initSqlJs({
        locateFile: (file) => `https://sql.js.org/dist/${file}`,
      });
      db = new SQL.Database();

      db.run(`CREATE TABLE bool_injection (username VARCHAR, password VARCHAR);
    INSERT INTO bool_injection (username, password) VALUES ('admin', 'this_is_a_secure_password_that_you_shouldnt_crack_or_look_at_source_for_use_the_SQL_injection_ty');`);
    };
    initSql();
  });

  const runBoolDemo = () => {
    try {
      const res = db.exec(
        `SELECT * FROM bool_injection WHERE username = 'admin' AND password = '${boolPassword}'`
      );
      console.log(res);
      if (res.length > 0 && res[0].values.length > 0) {
        boolSolveState = "solved";
      } else {
        boolSolveState = "wrong";
      }
    } catch (e) {
      boolSolveState = "error";
      console.warn(e);
    }
  };
</script>

<h2>What is SQL Injection?</h2>

<img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" alt="xkcd: exploits of a mom" />
<p>
  Most websites that need to store data often use SQL databases to store their data. When querying
  this database, you often need to include variables. All SQL interfaces provide you a safe way of
  including variables into the query, but sometimes developers will not use these sanitized way of
  including variables.
</p>

<Prism
  lang="js"
  code={`// Safely putting the variable productId into the query
client.query("SELECT product_name, price FROM products WHERE product_id = $1", [productId]);

// Unsafely putting the variable productId into the query by using string interpolation
client.query(\`SELECT product_name, price FROM products WHERE product_id = '\${productId}'';\`);`}
/>

<p>
  If the variables are handled usafely, and you have control over the variables, you are able to
  write your own SQL into the query.
</p>

<Prism
  lang="sql"
  code={`SELECT product_name, price FROM products WHERE product_id = ''
--                                                                  payload
--                                                            |----------------|
 SELECT product_name, price FROM products WHERE product_id = '' AND price = 1 --'`}
/>

<h2>Boolean Based SQL Injection</h2>

<p>
  A boolean based SQL Injection is where you use boolean comparisions to match rows that generally
  wouldn't be matched. For example, using <code>OR 1=1</code> in order to fufill the password requirement,
  without having the password. Try injecting some SQL to pass the following check.
</p>

<div class="py-8 font-sans text-center rounded-md not-prose width-full bg-zinc-800">
  <h1 class="mb-2 text-xl font-bold">Sign Up</h1>
  <input
    type="text"
    placeholder="Username"
    class="px-2 py-1 mb-2 rounded bg-zinc-500 text-zinc-400"
    disabled
    value="admin"
  />
  <br />
  <input
    type="text"
    placeholder="Password"
    class="px-2 py-1 mb-1 rounded bg-zinc-700 placeholder:text-zinc-400"
    bind:value={boolPassword}
  />
  <br />
  <button
    class="px-4 py-1 font-bold bg-purple-700 rounded hover:bg-purple-800 disabled:bg-purple-400 text-zinc-100"
    disabled={!db}
    on:click={runBoolDemo}>Sign Up</button
  >
</div>

<Prism
  lang="sql"
  code={`SELECT * FROM users WHERE username = 'admin' AND password = '${boolPassword}'`}
/>

<button
  class="px-4 py-1 font-bold rounded bg-emerald-700 hover:bg-emerald-800 text-zinc-100"
  on:click={() => (boolPassword = "' OR 1=1; --")}>Solve</button
>
<br />
{#if boolSolveState === "solved"}
  <span class="text-green-500">solved!</span>
{:else if boolSolveState === "error"}
  <span class="text-red-500">error.</span>
{:else if boolSolveState === "wrong"}
  <span class="text-red-500">wrong!</span>
{/if}

<p>
  Because the database has a user with username admin and 1 = 1, the query selects the admin user
  meaning that the server would log us into the admin account, even though we don't know the admin
  password!
</p>

<h2>Approaching a SQL Injection Challenge</h2>

<p>
  Most of the time, challenges won't give you the query to look at. Instead you'll have to make a
  guess at what the SQL query looks like.
</p>

<p>
  A good first step to solving any SQL Injection challenge is to write out what you think the query
  looks like. If a challenge looks something like this:
</p>
<div class="py-8 font-sans text-center rounded-md not-prose width-full bg-zinc-800">
  <h1 class="mb-2 text-xl font-bold">Sign Up</h1>
  <input
    type="text"
    placeholder="Username"
    class="px-2 py-1 mb-2 rounded bg-zinc-700 placeholder:text-zinc-400"
  />
  <br />
  <input
    type="text"
    placeholder="Password"
    class="px-2 py-1 mb-1 rounded bg-zinc-700 placeholder:text-zinc-400"
  />
  <br />
  <button class="px-2 py-1 font-bold bg-purple-700 rounded hover:bg-purple-800 text-zinc-100"
    >Sign Up</button
  >
</div>
